/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package visao;


import java.sql.Connection;
import comercial.controller.CaixasController;
import comercial.controller.DadosInstituicaoController;
import comercial.controller.DocumentosController;
import comercial.controller.FormaPagamentoController;
import comercial.controller.FormaPagamentoItemController;
import comercial.controller.ItemCaixaController;
import comercial.controller.UsuariosController;
import comercial.controller.VendasController;
import dao.FormaPagamentoDao;
import entity.Caixa;
import entity.TbDadosInstituicao;
import entity.TbUsuario;
import java.awt.Dimension;
import java.awt.HeadlessException;
import java.awt.Toolkit;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Objects;
import javax.persistence.EntityManagerFactory;
import javax.swing.JOptionPane;
import static kitanda.util.CfConstantes.YYYYMMDD_HHMMSS;
import util.BDConexao;
import util.BackupUsb;
import util.DVML;
import util.JPAEntityMannagerFactoryUtil;
import static util.MetodosUtil.rodarComandoWindows;

/**
 *
 * @author Domingos Dala Vunge
 */
public class CaixaAberturaVisao extends javax.swing.JFrame {

    private static EntityManagerFactory emf = JPAEntityMannagerFactoryUtil.em;
    private static DadosInstituicaoController dadosInstituicaoController;
    private static CaixasController caixa_controller;
    private static ItemCaixaController item_caixa_controller;
    private static FormaPagamentoItemController formaPagamentoItemController;
    private static FormaPagamentoController formaPagamentoController;
    private static VendasController vendasController;
    private static UsuariosController usuariosController;
    private final FormaPagamentoDao formaPagamentoDao = new FormaPagamentoDao(emf);
    private int idUser;
    private static BDConexao conexao;
    private static BDConexao conexaoTransaction;
    private boolean touch;

    public CaixaAberturaVisao(int idUser, BDConexao conexao, boolean touch) {
        initComponents();
        setLocationRelativeTo(null);
        Dimension dim = Toolkit.getDefaultToolkit().getScreenSize();
        this.setLocation(dim.width / 2 - this.getSize().width / 2, dim.height / 2 - this.getSize().height / 2);
        this.conexao = conexao;
        this.idUser = idUser;
        this.touch = touch;
        dadosInstituicaoController = new DadosInstituicaoController(CaixaAberturaVisao.conexao);
        caixa_controller = new CaixasController(CaixaAberturaVisao.conexao);
        item_caixa_controller = new ItemCaixaController(CaixaAberturaVisao.conexao);
        formaPagamentoItemController = new FormaPagamentoItemController(CaixaAberturaVisao.conexao);
        formaPagamentoController = new FormaPagamentoController(CaixaAberturaVisao.conexao);
        usuariosController = new UsuariosController(CaixaAberturaVisao.conexao);
        vendasController = new VendasController(CaixaAberturaVisao.conexao);
        setNumeroCaixa();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents()
    {

        jPanel1 = new javax.swing.JPanel();
        lbAberturaCaixa = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        txtValorInicial = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        jPanel3 = new javax.swing.JPanel();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("KITANDA - ABERTURA DE CAIXA");

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(""));

        lbAberturaCaixa.setFont(new java.awt.Font("Lucida Grande", 0, 36)); // NOI18N
        lbAberturaCaixa.setText("ABERTURA DE CAIXA");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lbAberturaCaixa, javax.swing.GroupLayout.PREFERRED_SIZE, 503, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(61, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(lbAberturaCaixa, javax.swing.GroupLayout.PREFERRED_SIZE, 78, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        txtValorInicial.setFont(new java.awt.Font("Lucida Grande", 0, 50)); // NOI18N
        txtValorInicial.addMouseListener(new java.awt.event.MouseAdapter()
        {
            public void mouseClicked(java.awt.event.MouseEvent evt)
            {
                txtValorInicialMouseClicked(evt);
            }
        });
        txtValorInicial.addActionListener(new java.awt.event.ActionListener()
        {
            public void actionPerformed(java.awt.event.ActionEvent evt)
            {
                txtValorInicialActionPerformed(evt);
            }
        });

        jLabel1.setFont(new java.awt.Font("Lucida Grande", 1, 13)); // NOI18N
        jLabel1.setText("Valor Inicial");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 167, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtValorInicial, javax.swing.GroupLayout.PREFERRED_SIZE, 474, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(29, 29, 29)
                .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 41, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtValorInicial, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(57, Short.MAX_VALUE))
        );

        jButton1.setText("Abrir caixa");
        jButton1.addActionListener(new java.awt.event.ActionListener()
        {
            public void actionPerformed(java.awt.event.ActionEvent evt)
            {
                jButton1ActionPerformed(evt);
            }
        });

        jButton2.setText("Sair");
        jButton2.addActionListener(new java.awt.event.ActionListener()
        {
            public void actionPerformed(java.awt.event.ActionEvent evt)
            {
                jButton2ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(27, 27, 27)
                .addComponent(jButton2, javax.swing.GroupLayout.PREFERRED_SIZE, 83, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(21, 21, 21))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jButton1, javax.swing.GroupLayout.DEFAULT_SIZE, 63, Short.MAX_VALUE)
                    .addComponent(jButton2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt)//GEN-FIRST:event_jButton1ActionPerformed
    {//GEN-HEADEREND:event_jButton1ActionPerformed
        // TODO add your handling code here:
        procedimento_abrir_caixa();
//        fazerBackupAgora();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt)//GEN-FIRST:event_jButton2ActionPerformed
    {//GEN-HEADEREND:event_jButton2ActionPerformed
        // TODO add your handling code here:
        dispose();
    }//GEN-LAST:event_jButton2ActionPerformed

    private void txtValorInicialActionPerformed(java.awt.event.ActionEvent evt)//GEN-FIRST:event_txtValorInicialActionPerformed
    {//GEN-HEADEREND:event_txtValorInicialActionPerformed
        procedimento_abrir_caixa();
//        fazerBackupAgora();

    }//GEN-LAST:event_txtValorInicialActionPerformed

    private void txtValorInicialMouseClicked(java.awt.event.MouseEvent evt)//GEN-FIRST:event_txtValorInicialMouseClicked
    {//GEN-HEADEREND:event_txtValorInicialMouseClicked
        // TODO add your handling code here:
        if (touch) {

            new TecladoNumeroPOSVisao(this, touch, null, 0, 0, DVML.NUMERO_TECLADO_ABERTURA_CAIXA).setVisible(true);
        }
    }//GEN-LAST:event_txtValorInicialMouseClicked

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Windows".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(CaixaAberturaVisao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(CaixaAberturaVisao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(CaixaAberturaVisao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(CaixaAberturaVisao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new CaixaAberturaVisao(15, BDConexao.getInstancia(), false).setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JLabel lbAberturaCaixa;
    public static javax.swing.JTextField txtValorInicial;
    // End of variables declaration//GEN-END:variables

//    TbUsuario usuario = ( TbUsuario ) usuariosController.findById( this.idUser );
//        if ( usuario.getIdTipoUsuario().getIdTipoUsuario() == DVML.COD_TIPO_USUARIO_SUB_ADMINISTRADOR )
//    private void procedimento_abrir_caixa()
//    {
//        conexaoTransaction = BDConexao.getInstancia();
//        DocumentosController.startTransaction( conexaoTransaction );
//        TbDadosInstituicao dadosInstituicao = ( TbDadosInstituicao ) dadosInstituicaoController.findById( 1 );
//        if ( camposValidos() )
//        {
//            System.out.println( "Cheguei antes do existe caixa" );
//            if ( !caixa_controller.existeCaixas() )
//            {
//                System.out.println( "Cheguei depois do existe caixa" );
//                try
//                {
//                    abrir_caixa();
//                }
//                catch ( Exception e )
//                {
//                }
//
//            }
//            else
//            {
//                Caixa caixa_actual = caixa_controller.findByCodigo( caixa_controller.getLastCaixa() );
//                if ( !Objects.isNull( caixa_actual.getDataFecho() ) )
//                {
//
//                    try
//                    {
//                        abrir_caixa();
//                    }
//                    catch ( Exception e )
//                    {
//                    }
//                    dispose();
////                    if ( ( dadosInstituicao.getMenuPrincipalByNegocio().equals( "Lavandaria" ) ) && ( usuario.getIdTipoUsuario().getIdTipoUsuario() == DVML.COD_TIPO_USUARIO_SUB_ADMINISTRADOR ) )
//                    if ( ( dadosInstituicao.getNegocio().equals( "Lavandaria" ) ) )
//                    {
//                        JanelaFrontOfficeLavandariaVisao.alterar_status_botao();
//                    }
//                    else
//                    {
//                        RootVisao.alterar_status_botao();
//                    }
//                }
//                else
//                {
//                    JOptionPane.showMessageDialog( null, "Caro usuário deve fechar o caixa actual (nº  " + caixa_actual.getPkCaixa() + ")", "Aviso", JOptionPane.WARNING_MESSAGE );
//                }
//
//            }
//
//        }
//
//    }
    private void procedimento_abrir_caixa() {

        TbDadosInstituicao dadosInstituicao = (TbDadosInstituicao) dadosInstituicaoController.findById(1);
        if (camposValidos()) {
            System.out.println("Cheguei antes do existe caixa");
            if (!caixa_controller.existeCaixas(idUser)) {
                System.out.println("Cheguei depois do existe caixa");
                try {
                    abrir_caixa();
                } catch (Exception e) {
                    e.printStackTrace();
                }

            } else {
                Caixa caixa_actual = caixa_controller.findByCodigo(caixa_controller.getLastCaixa(idUser));
                if (!Objects.isNull(caixa_actual.getDataFecho())) {

                    try {
                        abrir_caixa();
                    } catch (Exception e) {
                    }
                    dispose();
//                    if ( ( dadosInstituicao.getMenuPrincipalByNegocio().equals( "Lavandaria" ) ) && ( usuario.getIdTipoUsuario().getIdTipoUsuario() == DVML.COD_TIPO_USUARIO_SUB_ADMINISTRADOR ) )
                    if ((dadosInstituicao.getNegocio().equals("Lavandaria"))) {
//                        RootVisao.alterar_status_botao();
                    } else {
//                        RootVisao.alterar_status_botao();
                    }
                } else {
                    JOptionPane.showMessageDialog(null, "Caro usuário deve fechar o caixa actual (nº  " + caixa_actual.getPkCaixa() + ")", "Aviso", JOptionPane.WARNING_MESSAGE);
                }

            }

        }
    }

    private void abrir_caixa() {

        conexaoTransaction = BDConexao.getInstancia();
        DocumentosController.start(conexaoTransaction);
        TbUsuario usuario = (TbUsuario) usuariosController.findById(idUser);
        Caixa caixa = new Caixa();
        caixa.setDataAbertura(new Date());
        caixa.setDataFecho(null);
        caixa.setTotalVendas(0d);
        caixa.setNumeroVendas(0);
        caixa.setValorInicial(Double.valueOf(txtValorInicial.getText()));
        caixa.setUsuarioAbertura(usuario.getNome());
        caixa.setUsuarioFecho("");
        caixa.setCodUsuarioAbertura(usuario.getCodigo());
        caixa.setCodUsuarioFecho(0);
        caixa.setTotalDesconto(new BigDecimal(0d));
        caixa.setTotalIva(new BigDecimal(0d));
        caixa.setTotaIIliquido(new BigDecimal(0d));

        try {
            if (caixa_controller.salvar(caixa)) {
                JOptionPane.showMessageDialog(null, "Caixa aberto com sucesso!");
                DocumentosController.commit(conexaoTransaction);
                conexaoTransaction.close();

            BackupUsb.realizarBackup();

                dispose();
            } else {
                JOptionPane.showMessageDialog(null, "Falha ao abrir o caixa", "Aviso", JOptionPane.WARNING_MESSAGE);
            }

//            RootVisao.alterar_status_botao();
//            JanelaFrontOfficeLavandariaVisao.alterar_status_botao();
        } catch (HeadlessException e) {
            JOptionPane.showMessageDialog(null, "Falha ao abrir o caixa: " + e.getLocalizedMessage(), "Falha", JOptionPane.ERROR_MESSAGE);
            DocumentosController.rollback(conexaoTransaction);
            conexaoTransaction.close();
        }
    }

    private void limpar_dados_formulario() {
        txtValorInicial.setText("");
    }

    private boolean camposValidos() {
        if (txtValorInicial.getText().equals("")) {
            JOptionPane.showMessageDialog(null, "Caro usuário insira o valor inicial", "Aviso", JOptionPane.WARNING_MESSAGE);
            txtValorInicial.requestFocus();
            return false;
        }

        return true;
    }

    private void setNumeroCaixa() {
        try {
            Caixa caixa_actual = caixa_controller.caixa_actual();
            if (caixa_actual != null) {
                lbAberturaCaixa.setText("ABERTURA DE CAIXA Nº " + (caixa_actual.getPkCaixa() + 1));
            } else {
                lbAberturaCaixa.setText("ABERTURA DE CAIXA Nº 1 ");
            }
        } catch (Exception e) {
        }

    }

    public static void fazerBackupAgora() {
        String data = new SimpleDateFormat(YYYYMMDD_HHMMSS).format(new Date());
//        String rodar_camando = "cmd /c mysqldump -uroot -pDoV90x?# --dump-date --triggers --tables --routines --skip-quote-names --compact --skip-opt --skip-set-charset --hex-blob kitanda_db > \"..\\BD_BACKUP\\_database_backup_" + data + ".sql\"";
        String rodar_camando = "cmd /c mysqldump --single-transaction -uroot -pDoV90x?# --dump-date --triggers --add-drop-database --routines --skip-quote-names --skip-set-charset --add-locks --disable-keys --databases kitanda_db > \"..\\BD_BACKUP\\_database_backup_" + data + ".sql\"";
//String rodar_camando = "cmd /c mysqldump --single-transaction=TRUE -uroot -pDoV90x?# --dump-date --triggers --add-drop-database  --routines --skip-quote-names --compact --skip-opt --skip-set-charset --hex-blob --add-locks --disable-keys --lock-tables  --databases kitanda_db > \"..\\BD_BACKUP\\_database_backup_" + data + ".sql\"";
        Process rodarComandoWindows = rodarComandoWindows(rodar_camando, true);

//        JOptionPane.showMessageDialog ( null, "Backup realizado com sucesso! ", "Notificação", JOptionPane.INFORMATION_MESSAGE );
        System.err.println("Backup realizado com sucesso! ");

    }

}
